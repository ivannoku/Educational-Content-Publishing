
steps:
  - id: copy-build-repo
    name: gcr.io/cloud-builders/git
    entrypoint: bash
    args:
      - -c
      - >-
        git clone --single-branch --branch ${_RELEASE_NAME} ${_DEPLOYMENT_REPO_URL} ./deployment
        && cd ./deployment
        && git config user.email $(gcloud auth list --filter=status:ACTIVE --format='value(account)')
        && echo -n "gcr.io/$PROJECT_ID/${_APP_NAME}:$SHORT_SHA" > substitutions/_APP_IMAGE_URL
        && echo -n "$SHORT_SHA" > substitutions/_APP_VERSION
        && echo -n "$COMMIT_SHA" > substitutions/_APP_COMMIT_SHA
        && git commit --allow-empty -am'branch:$BRANCH_NAME updated ($COMMIT_SHA)'
        && git push origin ${_RELEASE_NAME}

timeout: 3600s

substitutions:
  _DEPLOYMENT_REPO_URL: null
  _BUILD_ENV: null
  _APP_NAME: null
  _RELEASE_NAME: null
  _DEV_PROJECT_ID: educational-content-publish-env

images:
- gcr.io/$PROJECT_ID/${_APP_NAME}:$SHORT_SHA
- gcr.io/${_DEV_PROJECT_ID}/${_APP_NAME}:${_RELEASE_NAME}

logsBucket: 'gs://inputhealth-chr-cloudbuild-logs'  
